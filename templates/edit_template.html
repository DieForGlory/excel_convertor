{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% endblock %}

{% block content %}
<div class="container">
    <div style="text-align: center; margin-bottom: 2em;">
        <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ "{{ template.template_name }}"</h1>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('edit_template', template_id=template_id) }}" method="POST" enctype="multipart/form-data">

        <fieldset>
            <legend><span class="step-icon">üìÑ</span>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</legend>
            <div class="form-group">
                <label for="template_name">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
                <input type="text" id="template_name" name="template_name" value="{{ template.template_name }}" required>
            </div>
             <div class="form-group">
                <label for="header_start_cell">–Ø—á–µ–π–∫–∞ —Å –ø–µ—Ä–≤—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º</label>
                <input type="text" id="header_start_cell" name="header_start_cell" value="{{ template.header_start_cell }}" required>
            </div>

            <div class="form-group">
                <label for="excel_file">–ó–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞</label>
                <small style="display: block; color: #6c757d; margin-bottom: 5px;">–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: {{ template.excel_file | default('–Ω–µ —É–∫–∞–∑–∞–Ω', true) }}</small>
                <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xlsm">
                <small style="display: block; color: #6c757d;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π.</small>
            </div>

        </fieldset>

        <fieldset>
            <legend><span class="step-icon">‚öôÔ∏è</span>–ü—Ä–∞–≤–∏–ª–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</legend>
            <div id="rules-container">
                {% for rule in template.rules %}
                <div class="rule">
                    <div class="rule-inputs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center;">
                        <input type="text" name="source_cell" value="{{ rule.source_cell }}" placeholder="–Ø—á–µ–π–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ (A1)" required>
                        <input type="text" name="template_col" value="{{ rule.template_col }}" placeholder="–°—Ç–æ–ª–±–µ—Ü –≤ —à–∞–±–ª–æ–Ω–µ (C)" required>
                    </div>
                    <button type="button" class="btn-remove" onclick="this.parentElement.remove()">-</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary" onclick="addRule()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
        </fieldset>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

            {% if template.excel_file %}
                <a href="{{ url_for('download_template_file', template_id=template_id) }}" class="btn btn-success">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞</a>
            {% endif %}
        </div>
    </form>

    <div class="nav-link">
        <a href="{{ url_for('templates_list') }}">&larr; –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —à–∞–±–ª–æ–Ω–æ–≤</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function addRule() {
        const container = document.getElementById('rules-container');
        const ruleDiv = document.createElement('div');
        ruleDiv.className = 'rule';
        ruleDiv.innerHTML = `
            <div class="rule-inputs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center;">
                <input type="text" name="source_cell" placeholder="–Ø—á–µ–π–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ (A1)" required>
                <input type="text" name="template_col" placeholder="–°—Ç–æ–ª–±–µ—Ü –≤ —à–∞–±–ª–æ–Ω–µ (C)" required>
            </div>
            <button type="button" class="btn-remove" onclick="this.parentElement.remove()">-</button>
        `;
        container.appendChild(ruleDiv);
    }
</script>
{% endblock %}