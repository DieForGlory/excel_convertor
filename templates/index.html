{% extends "base.html" %}

{% block title %}Обработка данных{% endblock %}

{% block content %}
<div class="container">
    <h1>Инструмент обработки данных</h1>

    <div id="progress-container" style="display: none;">
        <div id="progress-status">Статус: ожидание загрузки...</div>
        <div id="progress-bar-wrapper">
            <div id="progress-bar">0%</div>
        </div>
    </div>

    <form id="upload-form" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="saved_template">1. Выберите сохраненный шаблон</label>
            <select name="saved_template" id="saved_template">
                <option value="">-- Ручная загрузка --</option>
                {% for tpl in saved_templates %}
                    <option value="{{ tpl.id }}">{{ tpl.template_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="source_file">2. Загрузите исходный файл с данными (.xlsx,.xlsm)</label>
            <input type="file" name="source_file" id="source_file" accept=".xlsx,.xlsm" required>
        </div>

        <div id="manual-template-container">
            <div class="form-group">
                <label for="template_file">3. Загрузите файл-шаблон (.xlsx,.xlsm)</label>
                <input type="file" name="template_file" id="template_file" accept=".xlsx,.xlsm">
            </div>
        </div>

        <hr>

        <div class="form-group">
             <label for="source_range_start">4. Укажите начальную ячейку в ИСХОДНОМ файле (указывайте первую ячейку таблицы)</label>
             <input type="text" name="source_range_start" id="source_range_start" placeholder="Например, A1" required>
        </div>

        <div class="form-group" id="template-range-container">
             <label for="template_range_start">5. Укажите начальную ячейку в файле-ШАБЛОНЕ (указывайте первую ячейку таблицы)</label>
             <input type="text" id="template_range_start" name="template_range_start" placeholder="Например, C5">
        </div>

        <hr>

        <div class="form-group">
            <label>6. Добавьте частные правила (необязательно, высший приоритет)</label>
            <div id="rules-container"></div>
            <button type="button" class="btn btn-secondary">+ Добавить правило</button>
        </div>

        <hr>

        <div class="form-group">
            <label>7. Дополнительные функции (пост-обработка)</label>
            <select name="post_processing_function" id="post_processing_function">
                <option value="none">-- Без функции --</option>
                <option value="coords_to_address">Заполнить 'Адрес' по 'Широте' и 'Долготе'</option>
                <option value="address_to_coords">Заполнить 'Широту' и 'Долготу' по 'Адресу'</option>
            </select>
        </div>

        <hr>

        <button type="submit" class="btn btn-primary">Обработать и скачать</button>
    </form>
</div>
{% endblock %}