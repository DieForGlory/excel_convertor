{% extends "base.html" %}

{% block title %}Главная{% endblock %}

{% block content %}
<div class="container">
    <h1>Конвертер Excel файлов</h1>

    <form id="process-form" action="/process" method="POST" enctype="multipart/form-data">

        <div id="error-messages" class="error-container" style="display:none; color: #d9534f; background-color: #f2dede; border: 1px solid #ebccd1; padding: 15px; border-radius: 4px; margin-bottom: 20px;"></div>

        <fieldset>
            <legend><span class="step-icon">1</span> Исходный файл</legend>
            <div class="form-group">
                <label for="source_file">Файл (.xlsx, .xlsm)</label>
                <input type="file" id="source_file" name="source_file" required accept=".xlsx, .xlsm">
            </div>
            <div class="form-group">
                <label for="source_range_start">Ячейка с первым заголовком</label>
                <input type="text" id="source_range_start" name="source_range_start" placeholder="Например, A5" required>
            </div>
        </fieldset>

        <fieldset>
            <legend><span class="step-icon">2</span> Файл-шаблон</legend>
            <div class="form-group">
                <label for="saved_template">Использовать сохраненный шаблон</label>
                <select id="saved_template" name="saved_template">
                    <option value="">-- Не использовать (загрузить вручную) --</option>
                    {% for tpl in saved_templates %}
                    <option value="{{ tpl.id }}">{{ tpl.template_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="new-template-fields">
                <div class="form-group">
                    <label for="template_file">Загрузить файл (.xlsx, .xlsm)</label>
                    <input type="file" id="template_file" name="template_file" accept=".xlsx, .xlsm">
                </div>
                <div class="form-group">
                    <label for="template_range_start">Ячейка с первым заголовком</label>
                    <input type="text" id="template_range_start" name="template_range_start" placeholder="Например, B1">
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend><span class="step-icon">3</span> Частные правила (опционально)</legend>
            <div id="manual-rules-container">
                </div>
            <button type="button" id="add-manual-rule" class="btn btn-secondary">+ Добавить правило</button>
        </fieldset>

        <fieldset>
            <legend><span class="step-icon">4</span> Пост-обработка (Dadata)</legend>
            <div class="form-group">
                <label for="post_processing_function">Функция</label>
                <select id="post_processing_function" name="post_processing_function">
                    <option value="none">Без обработки</option>
                    <option value="coords_to_address">Координаты → Адрес</option>
                    <option value="address_to_coords">Адрес → Координаты</option>
                </select>
            </div>
        </fieldset>

        <button type="submit" class="btn btn-primary">Начать обработку</button>
    </form>

    <div id="progress-container" style="display:none; margin-top: 20px;">
        <h3>Статус:</h3>
        <p id="status-text">Ожидание...</p>
        <div class="progress-bar-background">
            <div id="progress-bar" class="progress-bar-foreground"></div>
        </div>
        <a href="#" id="download-link" class="btn btn-success" style="display:none; margin-top: 10px;">Скачать результат</a>
    </div>

</div>
{% endblock %}